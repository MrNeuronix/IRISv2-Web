#{extends 'main.html' /}
#{set title:'Скрипты' /}

<script src="/public/javascripts/interact-1.2.2.min.js"></script>

<style>
    .mapbox {
        background: url('/maps/render/${map.id}') no-repeat center center;
        height: 650px;
        width: 1100px;
    }

    .dropzone {
        background-color: #ccc;
        border: dashed 4px transparent;
        border-radius: 4px;
        margin: 10px auto 30px;
        padding: 10px;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .drop-active {
        border-color: #666;
    }

    .drop-target {
        background-color: #29e;
    }

    .draggable {
        position: relative;
        background-size: contain;
        display: inline-block;
        -webkit-transform: translate(0px, 0px);
        transform: translate(0px, 0px);
    }

    .drag-drop .can-drop { background-color: #4e4; }

</style>

<script>
    $(function () {

        // target elements with the "draggable" class
        interact('.draggable')
                .draggable({
                    // enable inertial throwing
                    inertia: false,
                    // keep the element within the area of it's parent
                    restrict: {
                        restriction: "parent",
                        endOnly: true,
                        elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
                    },
                    // call this function on every dragmove event
                    onmove: function (event) {
                        var target = event.target,
                        // keep the dragged position in the data-x/data-y attributes
                                x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
                                y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                        // translate the element
                        target.style.webkitTransform =
                                target.style.transform =
                                        'translate(' + x + 'px, ' + y + 'px)';

                        // update the posiion attributes
                        target.setAttribute('data-x', x);
                        target.setAttribute('data-y', y);
                    }
                });

        // enable draggables to be dropped into this
        interact('.dropzone').dropzone({

            overlap: 0.75,

            ondropactivate: function (event) {
                // add active dropzone feedback
                event.target.classList.add('drop-active');
            },
            ondrop: function (event) {

                var X = event.relatedTarget.getAttribute('data-x');
                var Y = event.relatedTarget.getAttribute('data-y');

                //event.relatedTarget.textContent = 'X: ' + X + " Y: " + Y;
            }
        });

    });
</script>

<div>
    <ul class="breadcrumb">
        <li>
            <a href="/">Главная</a> <span class="divider">/</span>
        </li>
        <li>
            <a href="/maps">Карты</a>
        </li>
    </ul>
</div>

<div class="row-fluid sortable">
    <div class="box span12">
        <div class="box-header well" data-original-title>
            <h2><i class="icon-picture"></i> Редактирование карты "${map.name}"</h2>
            <div class="box-icon">
                <a href="#" class="btn btn-setting btn-round"><i class="icon-cog"></i></a>
                <a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
                <a href="#" class="btn btn-close btn-round"><i class="icon-remove"></i></a>
            </div>
        </div>
        <div class="box-content">

            <div class="mapbox dropzone" id="inner-dropzone">
                #{list devices, as:'device'}

                    %{
                        if(device.iconon != null)
                            java.awt.image.BufferedImage img = javax.imageio.ImageIO.read(new java.io.ByteArrayInputStream(device.iconon));
                    }%

                    #{if img != null}
                        <div class="draggable" style="width: ${img.getWidth()}px; height: ${img.getHeight()}px; background: url('/maps/icon/on/${device.id}') no-repeat center center;"></div>
                    #{/if}
                    #{else }
                        <div class="draggable" style="width: 64px; height: 64px; background: url('/maps/icon/on/${device.id}') no-repeat center center;"></div>
                    #{/else}
                #{/list}
            </div>

        </div>
    </div><!--/span-->
</div><!--/row-->
